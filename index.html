<!DOCTYPE html>
<html>

<body>
    <p>Mode:</p>
    <input type="radio" id="paint" name="mode" value="paint">
    <label for="paint">Paint</label><br>
    <input type="radio" id="erase" name="mode" value="erase">
    <label for="erase">Erase</label><br>
    <input type="radio" id="select" name="mode" value="select">
    <label for="select">Select</label>
    <br>
    <label for="paintcolor">Active Color:</label>
    <input type="color" id="paintcolor" name="paintcolor" value="#ff0000">
    <button type="button" id="loadButton">Load Script</button>
    <button type="button" id="writeButton">Write Script</button>
    <button type="button" id="stepButton">Step</button>
    <br>
    <canvas id="myCanvas" width="300" height="300" style="border:1px solid black"></canvas>
    <textarea id="scriptArea" name="scriptArea" rows="4" cols="50"></textarea>
    <script>
        class Led {
            constructor() {
                this.color = "white";
                this.on = false;
                this.isSelected = false;
                this.code = "nop";
                this.row = 0;
                this.col = 0;
                this.getRelative = function(s) {
                    /* The input is either one of the 4 pneumonics for directions, or a 'direction string' */
                    if (s.slice(0, 2) == 'r"')
                    {
                        console.log("Received directional string")
                        //TODO parse directional string
                    } else {
                        delta = [0, 0]
                        switch (s) {
                            case "LEFT":
                                delta[1] = -1
                                break;
                            case "RIGHT":
                                delta[1] = 1
                                break;
                            case "UP":
                                delta[0] = -1
                                break;
                            case "DOWN":
                                delta[0] = 1
                                break;
                        }
                        delta[0] += this.row
                        delta[1] += this.col

                        //adjust for negatives..
                        while (delta[0] < 0) {
                            delta[0] += rowCount;
                        }

                        while (delta[1] < 0) {
                            delta[1] += colCount;
                        }

                        // Take the modulus
                        delta[0] = delta[0] % rowCount
                        delta[1] = delta[1] % colCount

                        return leds[(delta[0] * colCount) + delta[1]]
                    }
                }
            }
        }
        var leds = []
        var newLeds = []
        const rowCount = 10
        const colCount = 10
        for (var i = 0; i < rowCount * colCount; ++i) {
            let coord = idx2Coord(i)
            leds[i] = new Led();
            leds[i].row = coord[0]
            leds[i].col = coord[1]
        }
        const canvas = document.getElementById("myCanvas");
        const writebutton = document.getElementById("writeButton");
        const loadButton = document.getElementById("loadButton");
        const stepButton = document.getElementById("stepButton");
        const scriptArea = document.getElementById("scriptArea");
        const ledWidth = canvas.width / rowCount
        const ledHeight = canvas.height / colCount
        const ctx = canvas.getContext("2d");
        var mouseDown = 0;

        canvas.addEventListener('mousedown', function (event) {
            mouseDown = 1
            console.log(mouseDown)
        });

        canvas.addEventListener('mouseup', function (event) {
            mouseDown = 0;
            console.log(mouseDown)
        });

        writeButton.addEventListener('click', function (event) {
            console.log("clicked write button")
            selected = leds.filter(function (led) { return led.isSelected })
            selected.forEach(item => item.code = scriptArea.value);
        });

        loadButton.addEventListener('click', function (event) {
            console.log("clicked load button")
            selected = leds.filter(function (led) { return led.isSelected })

            if (selected.length == 1) {
                scriptArea.value = selected[0].code
            }
        });

        stepButton.addEventListener('click', function (event) {
            console.log("clicked step button")
            newLeds = []
            for (i = 0; i < rowCount * colCount; ++i) {
                newLeds[i] = Object.assign({}, leds[i]);

                let codeLines = leds[i].code.split(/\r?\n/);

                // Execute the script until reach the end of program.
                let pc = 0;
                while (pc < codeLines.length) {
                    executeOperation(leds[i], codeLines[pc]);
                    ++pc;
                }
            }

            leds = newLeds

            drawLeds();
        });

        function executeOperation(led, codeLine) {
            code = codeLine.split(" ")
            switch (code[0]) {
                case "COPY":
                    {
                        delta = [0, 0]
                        switch (code[1]) {
                            case "LEFT":
                                delta[1] = -1
                                break;
                            case "RIGHT":
                                delta[1] = 1
                                break;
                            case "UP":
                                delta[0] = -1
                                break;
                            case "DOWN":
                                delta[0] = 1
                                break;
                        }
                        next = led.getRelative(code[1])
                        newLeds[i].color = leds[(colCount * next.row) + next.col].color
                    }
                    break;
                default:
                    console.log("Unsupported Operation")
                    break;
            }
        }

        function getCursorPosition(canvas, event) {
            const rect = canvas.getBoundingClientRect()
            const x = event.clientX - rect.left
            const y = event.clientY - rect.top
            return [x, y]
        }

        function getIndex(event) {
            let [x, y] = getCursorPosition(canvas, event);
            const row = Math.floor(y / ledHeight)
            const col = Math.floor(x / ledWidth)
            return [row, col]
        }

        function idx2Coord(idx) {
            return [Math.floor(idx / colCount), idx % colCount]
        }

        function selectLed(event) {
            let [row, col] = getIndex(event);
            let rv = !leds[(colCount * row) + col].isSelected;
            leds[(colCount * row) + col].isSelected = true;
            console.log("select");
            console.log([row, col]);
            return rv;
        }

        function lightLed(canvas, event, color) {
            let [row, col] = getIndex(event);

            /* Determine if the color is going to change */
            const hasChanged = (color != leds[(colCount * row) + col].color)

            /* Set the LED's new color */
            leds[(colCount * row) + col].color = color

            return hasChanged /* Return the change state, so we know to draw */
        }

        function resetSelection() {
            leds.forEach(item => item.isSelected = false);
        }

        function drawLeds() {
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = "2";

            ctx.beginPath();
            // Draw each led one by one
            for (var row = 0; row < colCount; ++row) {
                for (var col = 0; col < rowCount; ++col) {
                    var led = leds[(row * colCount) + col]
                    ctx.strokeStyle = "black"
                    ctx.fillStyle = led.color;
                    ctx.fillRect(col * ledWidth, row * ledHeight, ledWidth, ledHeight);
                    ctx.rect(col * ledWidth, row * ledHeight, ledWidth, ledHeight);
                }
            }

            // Commit the drawing to canvas
            ctx.stroke();

            ctx.beginPath();
            ctx.lineWidth = "2";
            // Go over again to draw highlighted leds.
            for (var row = 0; row < colCount; ++row) {
                for (var col = 0; col < rowCount; ++col) {
                    var led = leds[(row * colCount) + col]
                    if (led.isSelected) {
                        ctx.strokeStyle = "blue"
                        ctx.fillStyle = led.color;
                        ctx.fillRect(col * ledWidth, row * ledHeight, ledWidth, ledHeight);
                        ctx.rect(col * ledWidth, row * ledHeight, ledWidth, ledHeight);
                    }
                }
            }
            ctx.stroke();
        }

        function getMode() {
            var ele = document.getElementsByName('mode');
            var mode = "none"

            for (i = 0; i < ele.length; ++i) {
                if (ele[i].checked) {
                    mode = ele[i].value;
                }
            }

            return mode
        }

        canvas.addEventListener('click', function (event) {
            const mode = getMode();
            if (mode == "paint") {
                const color = document.getElementById("paintcolor").value;
                if (lightLed(canvas, event, color)) {
                    drawLeds();
                }
            } else if (mode == "erase") {
                if (lightLed(canvas, event, "white")) {
                    drawLeds();
                }
            } else if (mode == "select") {
                if (selectLed(event)) {
                    drawLeds();
                }
            }
        });

        /* Reset the mouseDown state if we mouse out of the canvas */
        canvas.addEventListener('mouseout', function (event) {
            mouseDown = 0
        });

        canvas.addEventListener('mousemove', function (event) {
            const mode = getMode();
            if (mode == "paint") {
                if (mouseDown) {
                    const color = document.getElementById("paintcolor").value;
                    if (lightLed(canvas, event, color)) {
                        drawLeds();
                    }
                }
            } else if (mode == "erase") {
                if (mouseDown) {
                    if (lightLed(canvas, event, "white")) {
                        drawLeds();
                    }
                }
            } else if (mode == "select") {
                if (mouseDown) {
                    if (selectLed(event)) {
                        drawLeds();
                    }
                }
            }
        });

        // attach event handlers to radio buttons to reset selection
        var ele = document.getElementsByName('mode');

        for (i = 0; i < ele.length; ++i) {
            ele[i].addEventListener('click', function (event) {
                resetSelection();
                drawLeds();
            });
        }

        drawLeds();
    </script>
</body>

</html>